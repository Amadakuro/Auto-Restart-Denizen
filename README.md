# Документация для администраторов: Скрипт авторестарта сервера на Denizen

## Описание

Этот скрипт предназначен для автоматического и ручного перезапуска сервера Minecraft с использованием плагина Denizen. Он предоставляет гибкие настройки времени рестарта, уведомления для игроков, графический интерфейс (GUI) для управления, а также команды для настройки и контроля процесса. Скрипт разработан с учётом удобства использования и минимальной нагрузки на сервер.

---

## Установка

1. Убедитесь, что на сервере установлен плагин **Denizen** (скачать можно с [DenizenScript.com](https://denizenscript.com/)).
2. Скопируйте файл `autorestart.dsc` в папку `plugins/Denizen/scripts/`.
3. Перезапустите сервер или выполните команду `/denizen reload` для загрузки скрипта.

---

## Как работает скрипт?

### Автоматический запуск
- При старте сервера скрипт автоматически устанавливает время рестарта (по умолчанию 05:00) и время предупреждения (по умолчанию 04:00).
- Если авторестарт включён (по умолчанию включён), скрипт проверяет текущее время каждую минуту.
- Когда текущее время совпадает с временем предупреждения, игроки получают уведомление.
- Когда наступает время рестарта, запускается процесс перезапуска с обратным отсчётом.

### Уведомления игрокам
Игроки получают следующие сообщения перед рестартом:
- За 1 час (по умолчанию в 04:00):  
  `Внимание: сервер перезагрузится через 1 час. Пожалуйста, сохраните свои ресурсы!`
- За 30 секунд до рестарта:  
  `Авторестарт сервера начнется через 30 секунд...`
- Обратный отсчёт:  
  `Рестарт через 20 секунд...`  
  `Рестарт через 10 секунд...`  
  `Рестарт через 5 секунд...`  
  `Рестарт через 4 секунды...`  
  `Рестарт через 3 секунды...`  
  `Рестарт через 2 секунды...`  
  `Рестарт через 1 секунду...`
- Перед рестартом:  
  `Сервер перезапускается сейчас!`

### Перезапуск
- Когда наступает время рестарта (или при ручном запуске), сервер выполняет команду `stop`, перезапускаясь.
- Для автоматического перезапуска после остановки сервера требуется настроенный скрипт (например, `start.sh`).

### Команды для управления

1. **/autorestart enable**  
   **Описание**: Включает авторестарт.  
   **Пример**: `/autorestart enable`  
   **Права доступа**: Требуется разрешение `autorestart.admin` (по умолчанию есть у операторов).  
   **Результат**:  
   Вы получите сообщение: `Авторестарт включен.`

2. **/autorestart disable**  
   **Описание**: Отключает авторестарт.  
   **Пример**: `/autorestart disable`  
   **Права доступа**: Требуется разрешение `autorestart.admin`.  
   **Результат**:  
   Вы получите сообщение: `Авторестарт отключен.`

3. **/autorestart status**  
   **Описание**: Показывает текущее состояние авторестарта, время рестарта и предупреждения.  
   **Пример**: `/autorestart status`  
   **Права доступа**: Требуется разрешение `autorestart.admin`.  
   **Результат**:  
   Пример вывода:  
   ```
   Состояние авторестарта: enabled
   Рестарт в: 05:00
   Предупреждение в: 04:00
   ```

4. **/autorestart manual**  
   **Описание**: Запускает ручной рестарт с 30-секундным отсчётом.  
   **Пример**: `/autorestart manual`  
   **Права доступа**: Требуется разрешение `autorestart.admin`.  
   **Результат**:  
   Вы получите сообщение: `Ручной рестарт сервера начнется через 30 секунд...`, после чего начнётся отсчёт.

5. **/autorestart settimes <рестарт HH:MM> <предупреждение HH:MM>**  
   **Описание**: Устанавливает время рестарта и предупреждения в формате часов и минут (24-часовой формат).  
   **Пример**: `/autorestart settimes 06:00 05:00`  
   **Права доступа**: Требуется разрешение `autorestart.admin`.  
   **Особенности**:  
   - Время должно быть в формате `HH:MM` (например, `06:00`).  
   - Часы должны быть в диапазоне 0–23, минуты — 0–59.  
   **Результат**:  
   Вы получите сообщение:  
   ```
   Время рестарта установлено на 06:00
   Предупреждение установлено на 05:00
   ```  
   **Ошибки**:  
   - Если введён неверный формат (например, `/autorestart settimes 25:00 04:00`):  
     `Неверный формат времени рестарта! Используйте HH:MM`  
   - Если часы или минуты вне диапазона:  
     `Часы рестарта вне диапазона! Должно быть числом от 0 до 23.`

6. **/autorestart gui**  
   **Описание**: Открывает графический интерфейс для управления авторестартом.  
   **Пример**: `/autorestart gui`  
   **Права доступа**: Требуется разрешение `autorestart.admin`.  
   **Результат**:  
   Открывается GUI с тремя предметами:  
   - **Зелёный блок (слот 2)**: Включить авторестарт.  
   - **Красный блок (слот 5)**: Отключить авторестарт.  
   - **Часы (слот 8)**: Запустить ручной рестарт.

---

## Примеры использования

### Сценарий 1: Установка рестарта на определённое время
1. Выполните: `/autorestart settimes 02:00 01:00`.  
2. Получите сообщение:  
   ```
   Время рестарта установлено на 02:00
   Предупреждение установлено на 01:00
   ```
3. В 01:00 всем игрокам придёт:  
   `Внимание: сервер перезагрузится через 1 час. Пожалуйста, сохраните свои ресурсы!`
4. В 02:00 начнётся отсчёт, и сервер перезапустится.

### Сценарий 2: Ручной рестарт через GUI
1. Выполните: `/autorestart gui`.  
2. Откроется GUI.  
3. Кликните на **Часы** (слот 8).  
4. Получите сообщение: `Ручной рестарт через 30 секунд...`.  
5. Сервер перезапустится через 30 секунд с уведомлениями.

### Сценарий 3: Отключение авторестарта
1. Выполните: `/autorestart disable`.  
2. Получите: `Авторестарт отключен.`  
3. Сервер не будет перезапускаться автоматически, пока авторестарт не включён снова.

---

## Логирование

В текущей версии скрипта логирование не реализовано. Однако вы можете добавить его, записывая события (например, рестарт или изменение настроек) в файл `plugins/Denizen/restart_log.txt`. Для этого нужно добавить задачу логирования в скрипт.

---

## Требования и рекомендации

- **Плагины**: Нужен только Denizen (версия 1.2.5 или новее).  
- **Права**: Убедитесь, что у администраторов есть право `autorestart.admin` (можно настроить через плагин прав, например, LuckPerms).  
  Пример команды для LuckPerms:  
  ```
  /lp user <username> permission set autorestart.admin true
  ```
- **Рестарт**: Команда `stop` должна быть поддерживаемой вашим сервером (работает в Spigot/Paper). Для автоматического перезапуска после остановки настройте скрипт (например, `start.sh`).  
  Если используется другой способ рестарта (например, через хостинг-панель), замените `execute as_server "stop"` на нужную команду.

---

## Устранение неполадок

- **Скрипт не работает**:  
  Проверьте, загружен ли он (`/denizen reload`) и нет ли ошибок в консоли. Убедитесь, что файл `autorestart.dsc` находится в папке `plugins/Denizen/scripts/`.

- **Рестарт не происходит**:  
  Убедитесь, что команда `stop` работает на вашем сервере (протестируйте вручную в консоли). Проверьте, включён ли авторестарт (`/autorestart status`).

- **Сообщения не появляются**:  
  Проверьте, включён ли авторестарт (`/autorestart status`). Убедитесь, что текущее время совпадает с заданным временем рестарта или предупреждения. Проверьте синтаксис в файле скрипта — ошибка в YAML (например, лишний пробел) может сломать скрипт.

- **GUI не открывается**:  
  Убедитесь, что у игрока есть пермишен `autorestart.admin`. Проверьте, что скрипт корректно загружен.

- Если что-то не работает, обратитесь к логам Denizen в `plugins/Denizen/debug.log`.

---

## Преимущества

- Минимальная нагрузка на сервер благодаря проверке времени раз в минуту.  
- Удобные уведомления для игроков с обратным отсчётом.  
- Гибкость в управлении временем рестарта через команды.  
- Простой и интуитивный GUI для управления авторестартом.  

Теперь вы можете легко управлять перезапусками сервера! Если нужны изменения (например, другие интервалы уведомлений или добавление логирования), обратитесь к разработчику скрипта.
